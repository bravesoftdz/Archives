unit Model_Wiki;

interface

uses
   FireDAC.Comp.Client
  ,FireDAC.Stan.Param
  ,Data.DB
  ,API_Parse;

type
  TWikiModel = class(TModelParse)
  // частные методы
  private
    procedure ParseObjectList(aLinkId: Integer; aPage: string);
    procedure ParseObject(aLinkId: Integer; aPage: string);

  // переопределяемые методы
  private
    procedure SetStartLinks(aLinkID: integer); override;
    procedure SetParseMethods(aLevel: Integer); override;
  protected
    procedure InitParserData; override;
  end;

implementation

procedure TWikiModel.ParseObject(aLinkId: Integer; aPage: string);
var
  tx: string;
begin
  // title
  tx:=FParcer.ParseByKey(aPage, 'class="infobox vcard', '</td>');
  tx:=FParcer.ParseByKey(tx, '<tr>', '');
  tx:=FParcer.RemoveTags(tx);
  FParcer.AddData(aLinkId, 1, 'title', tx);

  // jgbcfyb

end;

procedure TWikiModel.ParseObjectList(aLinkId: Integer; aPage: string);
var
  tx: string;
  Rows: TArray<string>;
  Row: string;
  i: Integer;
begin
  tx:=FParcer.ParseByKey(aPage, 'class="mw-category"', '</div></div></div>');
  Rows:=FParcer.MultiParseByKey(tx, '<a href="', '"');

  i:=0;
  for Row in Rows do
    begin
      Inc(i);
      tx:='https://ru.wikipedia.org'+Row;
      FParcer.AddLink(2, tx, aLinkId, i);
    end;

  tx:=FParcer.ParseByKeyReverse(aPage,'#mw-pages','"',2);
  if Length(tx)>0 then
    begin
      tx:='https://ru.wikipedia.org'+tx;
      FParcer.AddLink(1, tx, aLinkId, 1);
    end;
end;

procedure TWikiModel.SetParseMethods(aLevel: Integer);
begin
  if aLevel=1 then FParseMethod:=ParseObjectList;
  if aLevel=2 then FParseMethod:=ParseObject;
end;

procedure TWikiModel.SetStartLinks(aLinkID: integer);
var
  dsStartLinks: TFDQuery;
  i: integer;
begin
  dsStartLinks:=TFDQuery.Create(nil);
  try
    FDBEngine.GetData(dsStartLinks, 'select * from params_roman_wiki order by id');
    for i := 1 to dsStartLinks.RecordCount do
      begin
        FParcer.AddLink(1, dsStartLinks.FieldByName('start_link').AsString, aLinkId, i);
        FParcer.AddData(aLinkId, i, 'Lang', 'ru');
        FParcer.AddData(aLinkId, i, 'Rubric', dsStartLinks.FieldByName('rubric').AsString);

        dsStartLinks.Next;
      end;
  finally
    dsStartLinks.Free
  end;
end;

procedure TWikiModel.InitParserData;
begin
  FEventData.AddOrSetValue('ParserName', 'roman_wiki');
  FEventData.AddOrSetValue('ZeroLink', 'https://www.wikipedia.org/');
end;

end.

unit Model_Wiki;

interface

uses
   FireDAC.Comp.Client
  ,FireDAC.Stan.Param
  ,Data.DB
  ,API_Parse;

type
  TWikiModel = class(TModelParse)
  // частные методы
  private
    function GetQueryText(aLang: string; aIsUpdate: Boolean): string;
    procedure ParseObjectList(aLinkId: Integer; aPage: string);
    procedure ParseObject(aLinkId: Integer; aPage: string);
    procedure CustomerTableAddRecord(aLinkId: integer);

  // переопределяемые методы
  private
    procedure SetStartLinks(aLinkID: integer); override;
    procedure SetParseMethods(aLevel: Integer); override;
  protected
    procedure InitParserData; override;
  end;

implementation

uses
  System.SysUtils;

function TWikiModel.GetQueryText(aLang: string; aIsUpdate: Boolean): string;
var
  sql: string;
begin
  if aIsUpdate then sql:='update parsed_sites set'
  else sql:='insert into parsed_sites set';

  sql:=sql+' ctime=:ctime';
  sql:=sql+',category_identifier=:category_identifier';
  sql:=sql+',site_url=:site_url';

  if aLang='ru' then
    begin
      sql:=sql+',ru_title=:title';
      sql:=sql+',ru_city=:city';
      sql:=sql+',ru_country=:country';
      sql:=sql+',ru_address=:address';
      sql:=sql+',ru_content=:content';
      sql:=sql+',ru_source=:source';
      sql:=sql+',ru_source_hash=md5(:source)';
    end;

  if aLang='en' then
    begin
      sql:=sql+',en_title=:title';
      sql:=sql+',en_city=:city';
      sql:=sql+',en_country=:country';
      sql:=sql+',en_address=:address';
      sql:=sql+',en_content=:content';
      sql:=sql+',en_source=:source';
      sql:=sql+',en_source_hash=md5(:source)';
    end;

  if aIsUpdate then sql:=sql+' where id = %d';
  Result:=sql;
end;

procedure TWikiModel.CustomerTableAddRecord(aLinkId: integer);
var
  dsQuery, dsContent: TFDQuery;
  sql, tx: string;
  level: Integer;
  City: string;
  Title: string;
  site: string;
  rubric: string;
  isUpdateMode: Boolean;
  Lang: string;
  UpdatedID: integer;
begin
  if FParcer.GetLinkLevel(aLinkId)=3 then isUpdateMode:=True;

  Lang:=FParcer.GetValueByKey(aLinkId, 'Lang', level);

  dsQuery:=TFDQuery.Create(nil);
  try
    if isUpdateMode then
      begin
        sql:='select ps.id';
        sql:=sql+' from links l';
        sql:=sql+' join links l2 on l2.id=l.parent_link_id';
        sql:=sql+' join parsed_sites ps on (ps.ru_source_hash=l2.link_hash) or (ps.en_source_hash=l2.link_hash)';
        sql:=sql+' where l.id=%d';
        sql:=Format(sql, [aLinkId]);
        dsQuery.SQL.Text:=sql;
        FDBEngine.OpenQuery(dsQuery);
        UpdatedID:=dsQuery.FieldByName('id').AsInteger;
      end;

    sql:=GetQueryText(Lang, isUpdateMode);

    dsQuery.SQL.Text:=sql;

    dsQuery.ParamByName('ctime').AsDateTime:=Now;

    rubric:=FParcer.GetValueByKey(aLinkId, 'Rubric', level);
    dsQuery.ParamByName('category_identifier').AsString:=rubric;

    Title:=FParcer.GetValueByKey(aLinkId, 'Title', level);
    City:=FParcer.GetValueByKey(aLinkId, 'City', level);

    if Lang='ru' then
      begin
        dsQuery.ParamByName('ru_title').AsString:=Title;
        dsQuery.ParamByName('en_title').Clear;

        dsQuery.ParamByName('ru_city').AsString:=City;
        dsQuery.ParamByName('en_city').Clear;

        dsQuery.ParamByName('ru_country').AsString:=FParcer.GetValueByKey(aLinkId, 'Country', level);
        dsQuery.ParamByName('en_country').Clear;

        dsQuery.ParamByName('ru_address').AsString:=FParcer.GetValueByKey(aLinkId, 'Address', level);
        dsQuery.ParamByName('en_address').Clear;

        dsQuery.ParamByName('en_content').Clear;

        dsQuery.ParamByName('ru_source').AsString:=FParcer.GetLinkById(aLinkId);
        dsQuery.ParamByName('en_source').Clear;

        dsQuery.ParamByName('ru_content').AsWideString:=FParcer.GetValueByKey(aLinkId, 'Description', level);
        dsQuery.ParamByName('en_content').Clear;
      end;

    if Lang='en' then
      begin
        dsQuery.ParamByName('en_title').AsString:=Title;
        dsQuery.ParamByName('ru_title').Clear;

        dsQuery.ParamByName('en_city').AsString:=City;
        dsQuery.ParamByName('ru_city').Clear;

        dsQuery.ParamByName('en_country').AsString:=FParcer.GetValueByKey(aLinkId, 'Country', level);
        dsQuery.ParamByName('ru_country').Clear;

        dsQuery.ParamByName('en_address').AsString:=FParcer.GetValueByKey(aLinkId, 'Address', level);
        dsQuery.ParamByName('ru_address').Clear;

        dsQuery.ParamByName('ru_content').Clear;

        dsQuery.ParamByName('en_source').AsString:=FParcer.GetLinkById(aLinkId);
        dsQuery.ParamByName('ru_source').Clear;

        dsQuery.ParamByName('en_content').AsString:=FParcer.GetValueByKey(aLinkId, 'Description', level);
        //dsQuery.ParamByName('ru_content').Clear;
      end;

    dsQuery.ParamByName('site_url').AsString:=TParseTool.Inplode(FParcer.GetArrayByKey(aLinkId, 'Web', 1),', ');

    dsQuery.ParamByName('en_title').DataType:=ftString;
    dsQuery.ParamByName('en_city').DataType:=ftString;
    dsQuery.ParamByName('en_country').DataType:=ftString;
    dsQuery.ParamByName('en_address').DataType:=ftString;
    dsQuery.ParamByName('en_content').DataType:=ftWideMemo;
    dsQuery.ParamByName('en_source').DataType:=ftString;
    dsQuery.ParamByName('ru_title').DataType:=ftString;
    dsQuery.ParamByName('ru_city').DataType:=ftString;
    dsQuery.ParamByName('ru_country').DataType:=ftString;
    dsQuery.ParamByName('ru_address').DataType:=ftString;
    //dsQuery.ParamByName('ru_content').DataType:=ftString;
    dsQuery.ParamByName('ru_source').DataType:=ftString;

    FDBEngine.ExecQuery(dsQuery);
  finally
    dsQuery.Free;
  end;
end;

procedure TWikiModel.ParseObject(aLinkId: Integer; aPage: string);
var
  tx: string;
  LastKey: string;
  address: string;
  rows: TArray<string>;
  i,j: Integer;
  row: string;
begin
  // title
  tx:=TParseTool.ParseByKey(aPage, 'class="infobox', '</tr>');
  tx:=TParseTool.ParseByKey(tx, '<tr>', '');
  tx:=TParseTool.RemoveTags(tx);
  FParcer.AddData(aLinkId, 1, 'Title', tx);

  // описание
  LastKey:='';
  if Pos('<span class="mw-headline" id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.87.D0.B0.D0.BD.D0.B8.D1.8F">', aPage)>0 then
    LastKey:='<span class="mw-headline" id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.87.D0.B0.D0.BD.D0.B8.D1.8F">'
  else
  if Pos('<span class="mw-headline" id=".D0.A1.D1.81.D1.8B.D0.BB.D0.BA.D0.B8">', aPage)>0 then
    LastKey:='<span class="mw-headline" id=".D0.A1.D1.81.D1.8B.D0.BB.D0.BA.D0.B8">'
  else
  if Pos('<span class="mw-headline" id="See_also"', aPage)>0 then
    LastKey:='<span class="mw-headline" id="See_also"'
  else
  if Pos('<span class="mw-headline" id="References"', aPage)>0 then
    LastKey:='<span class="mw-headline" id="References"';

  if LastKey='' then LastKey:='NewPP limit report';

  tx:=TParseTool.ParseByKey(aPage, '<p><b>', LastKey);

  tx:=TParseTool.CutBetween(tx, '<div id="toctitle">', '</ul>'+#$A+'</div>'); // удаляем содержание
  tx:=TParseTool.CutBetween(tx, '(<span class="bday">', ')</span>');
  tx:=TParseTool.CutBetween(tx, '(<span class="dday"', ')</span>');
  tx:=TParseTool.CutBetween(tx, '<sup', '</sup>'); // сноски
  tx:=TParseTool.CutBetween(tx, '<span class="mw-editsection">', '>]'); // править

  tx:=TParseTool.RemoveTags(tx);
  FParcer.AddData(aLinkId, 1, 'Description', tx);

  // адрес
  tx:=TParseTool.ParseByKey(aPage, 'Местоположение</th>', '</td>');
  if Length(tx)=0 then TParseTool.ParseByKey(aPage, 'Location</th>', '</td>');
  if Length(tx)>0 then
    begin
      address:=TParseTool.ParseByKey(tx, '<p>', '<');
      FParcer.AddData(aLinkId, 1, 'Address', row);
      rows:=TParseTool.MultiParseByKey(tx,'title="','<');
      j:=0;
      for i := Length(rows)-1 downto 0 do
        begin
          inc(j);
          if j>2 then Break;

          row:=rows[i];
          row:=TParseTool.CutBetween(row,'>','');
          if j=1 then FParcer.AddData(aLinkId, 1, 'Country', row);
          if j=2 then FParcer.AddData(aLinkId, 1, 'City', row);
        end;
    end;

  // сайт
  tx:=TParseTool.ParseByKey(aPage, 'class="infobox', '</table>');
  rows:=TParseTool.MultiParseByKey(tx,'<a rel="nofollow" class="external text" href="','"');
  i:=0;
  for row in rows do
    begin
      inc(i);
      FParcer.AddData(aLinkId, i, 'Web', row);
    end;
  tx:=TParseTool.ParseByKeyReverse(aPage, '">Официальный сайт<', '"', 1);
  if Length(tx)>0 then FParcer.AddData(aLinkId, i, 'Web', tx);
  tx:=TParseTool.ParseByKeyReverse(aPage, '">Official website<', '"', 1);
  if Length(tx)>0 then FParcer.AddData(aLinkId, i, 'Web', tx);

  // ссылка на страницу на других языках
  tx:=TParseTool.ParseByKey(aPage, 'interlanguage-link interwiki-en', '</a>');
  if Length(tx)=0 then TParseTool.ParseByKey(aPage, 'interlanguage-link interwiki-ru', '</a>');
  if Length(tx)>0 then
    begin
      tx:=TParseTool.ParseByKey(tx, 'href="', '"');
      tx:='https:'+tx;
      FParcer.AddLink(3, tx, aLinkId, 1);
    end;

  // пишем в результирующую таблицу
  CustomerTableAddRecord(aLinkId);
end;

procedure TWikiModel.ParseObjectList(aLinkId: Integer; aPage: string);
var
  tx: string;
  Rows: TArray<string>;
  Row: string;
  i: Integer;
begin
  tx:=TParseTool.ParseByKey(aPage, 'class="mw-category"', '</div></div></div>');
  Rows:=TParseTool.MultiParseByKey(tx, '<a href="', '"');

  i:=0;
  for Row in Rows do
    begin
      Inc(i);
      tx:='https://ru.wikipedia.org'+Row;
      FParcer.AddLink(2, tx, aLinkId, i);
    end;

  tx:=TParseTool.ParseByKeyReverse(aPage,'#mw-pages','"',2);
  if Length(tx)>0 then
    begin
      tx:='https://ru.wikipedia.org'+tx;
      FParcer.AddLink(1, tx, aLinkId, 1);
    end;
end;

procedure TWikiModel.SetParseMethods(aLevel: Integer);
begin
  if aLevel=1 then FParseMethod:=ParseObjectList;
  if aLevel=2 then FParseMethod:=ParseObject;
  if aLevel=3 then FParseMethod:=ParseObject;
end;

procedure TWikiModel.SetStartLinks(aLinkID: integer);
var
  dsStartLinks: TFDQuery;
  i: integer;
begin
  dsStartLinks:=TFDQuery.Create(nil);
  try
    FDBEngine.GetData(dsStartLinks, 'select * from params_roman_wiki order by id');
    for i := 1 to dsStartLinks.RecordCount do
      begin
        FParcer.AddLink(1, dsStartLinks.FieldByName('start_link').AsString, aLinkId, i);
        FParcer.AddData(aLinkId, i, 'Lang', 'ru');
        FParcer.AddData(aLinkId, i, 'Rubric', dsStartLinks.FieldByName('rubric').AsString);

        dsStartLinks.Next;
      end;
  finally
    dsStartLinks.Free
  end;
end;

procedure TWikiModel.InitParserData;
begin
  FEventData.AddOrSetValue('ParserName', 'roman_wiki');
  FEventData.AddOrSetValue('ZeroLink', 'https://www.wikipedia.org/');
end;

end.
